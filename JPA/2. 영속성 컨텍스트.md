# 2. 영속성 컨텍스트

---

## 영속성 컨텍스트

Entity를 영구저장하는 환경이라는 뜻이다. application과 database사이에서 객체를 보관하는 가상의 database역할(Entity manager)을 한다. 엔티티 매니저를 통해 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.

### 특징

- 엔티티 매니저를 생성할 때 하나 만들어진다.
- 엔티티 매니저를 통해서 영속성 컨텍스트에 접근하고 관리할 수 있다.

---

## **엔티티의 생명주기**

- 비영속(new/transient): 영속성 컨텍스트와 전혀 관계가 없는 상태
- 영속(managed): 영속성 컨텍스트에 저장된 상태
- 준영속(detached): 영속성 컨텍스트에 저장되었다가 분리된 상태
- 삭제(removed): 삭제된 상태

### 비영속 상태

엔티티 객체를 생성했지만 아직 영속성 컨텍스트에 저장하지 않은 상태

### 영속 상태

엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장한 상태, 영속성 컨텍스트에 의해 관리됨

### 준영속

영속성 컨텍스트가 관리하던 영속 상태의 엔티티 더이상 관리하지 않으면 준영속 상태가 된다

준영속 상태의 특징

- 1차 캐시, 쓰기 지연, 변경 감지, 지연 로딩을 포함한 영속성 컨텍스트가 제공하는 어떠한 기능도 동작하지 않는다.
- 식별자 값을 가지고 있다.

### 삭제

엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제된 상태

---

## 특징

- 영속성 컨텍스트는 엔티티를 식별자 값으로 구별한다. 그러므로 영속 상태는 식별자 값이 필요하다
- JPA는 보통 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터 베이스에 반영하는데 이를 `flush`라 한다.

## 장점

1. 1차 캐시 
2. 동일성 보장
3. 트랙잭션을 지원하는 쓰기 지연
4. 변경 감지
5. 지연 로딩

### 1차 캐시

영속성 컨텍스트 내부에는 캐시가 있는데 이를 1차캐시라고 한다. 영속 상태의 엔티티를 이곳에 저장한다. 1차 캐시의 키는 식별자 값이고 값은 엔티티 인스턴스이다

<aside>
💡 조회의 흐름
1. 1차 캐시에서 데이터를 찾는다
2. 있으면 1차 캐시에서 데이터를 조회한다
3. 없으면 데이터베이스에서 조회한다
4. 조회한 데이터를 1차 캐시에 저장한다.
5. 조회한 데이터를 반환한다

</aside>

### 동일성 보장

> 동일성 : 실제 인스턴스가 같다. `==`을 사용해 비교한다.
동등성 : 실제 인스턴스는 다를 수 있지만 인스턴스가 가지고 있는 값이 같다. `equals()`메소드를 구현해서 비교한다.
> 

### 쓰기지연

내부 쿼리 저장소에 INSERT SQL을 모아둔다. 그리고 트랜잭션을 커밋할 때 모아둔 쿼리를 DB에 보낸다

### 변경 감지

1. 클라이언트에서 식별자를 포함한 데이터를 넘김
2. 식별자(id)를 통해서 DB에서 데이터 조회 후, 조회된 데이터를 영속화
3. 클라이언트에서 넘어온 값들을 토대로 기존의 데이터를 새로운 데이터로 변경 : 변경점 발생
4. 트랜잭션 커밋
5. JPA에서 변경점들을 확인하고 변경해야할 것에 맞게 DB 쿼리를 실행 :

### 플러시

영속성 컨텍스트의 변경 내용을 DB에 반영해주는 것

1. 변경 감지가 동작해서 스냅샷과 비교해서 수정된 엔티티를 찾는다.

2. 수정된 엔티티에 대해서 수정 쿼리를 만들거 SQL 저장소에 등록한다.

3. 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송한다.
